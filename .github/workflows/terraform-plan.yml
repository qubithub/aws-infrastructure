name: Terraform Plan

on: 
  pull_request: 
    branches: 
      - main
    types: [opened, synchronize, reopened]
  

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs: 
  terraform: 
    runs-on: ubuntu-latest

    strategy: 
      matrix: 
        environment: [staging, production]

    defaults: 
      run: 
        working-directory: infra
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Login to AWS
        uses: aws-actions/configure-aws-credentials@v4
        with: 
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT }}:role/Terraform-Runner
          aws-region: mx-central-1
      
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with: 
          terraform_version: 1.13.5

      - name: Terraform Init
        run : |
          terraform init \
            -backend-config="envs/${{ vars.ENVIRONMENT }}.config"
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan
        run: terraform plan -out=tfplan-${{ vars.ENVIRONMENT }}
      
      - name: Show Plan Summary
        run: terraform show -no-color tfplan-${{ vars.ENVIRONMENT }}
      
      - name: Upload Plan to PR Comment
        if: success()
        uses: actions/github-script@v7
        with: 
          script: |
            const fs = require('fs');
            const output = await exec.getExecOutput('terraform show -no-color tfplan-${{ vars.ENVIRONMENT }}.bin');
            const body = `### Terraform plan for \`${{ vars.ENVIRONMENT }}\`\n\`\`\`\n${output.stdout}\n\`\`\``;
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
